#!/bin/bash

# Color definitions
red='\033[0;31m'
green='\033[0;32m'
yellow='\033[1;33m'
reset='\033[0m'

# Valid Script
ipsaya=$(curl -sS ipv4.icanhazip.com)
data_server=$(curl -v --insecure --silent https://google.com/ 2>&1 | grep Date | sed -e 's/< Date: //')
date_list=$(date +"%Y-%m-%d" -d "$data_server")

# Variables
ip=$(wget -qO- ipv4.icanhazip.com)
srv_date=$(curl -v --insecure --silent https://google.com/ 2>&1 | grep Date | sed -e 's/< Date: //')
date=$(date +"%Y-%m-%d" -d "$srv_date")
ip_url="https://ip.yha.my.id/ip"
city=$(cat /etc/xray/city 2>/dev/null || echo "Unknown city")
pubkey=$(cat /etc/slowdns/server.pub 2>/dev/null || echo "Pubkey not available")
domain=$(cat /etc/xray/domain 2>/dev/null || hostname -f)
# uuid=$(cat /proc/sys/kernel/random/uuid)

echo -e "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "                       Tambah Akun Xray Vless"
echo -e "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

while true; do
    read -p "   Nama: " user
    if [[ ${#user} -lt 3 || ! "$user" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        printf "\033[1A\033[0J"
        echo -e "${red}   Nama pengguna tidak boleh kosong${reset}"
        continue
    fi
    if grep -q "^### $user " /etc/xray/vless/config.json; then
        random_number=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 5)
        user="${random_number}${user}"
        echo -e "${yellow}   Nama pengguna sudah ada. Menggunakan nama baru: $user${reset}"
        break
    else
        break
    fi
done


read -p "   Kata sandi/UUID: " uuid
until [[ $duration =~ ^[0-9]+$ ]]; do
    read -p "   Masa aktif (hari): " duration
    if [[ -z "$duration" ]]; then
        echo -e "${red}Masa aktif tidak boleh kosong. Silakan coba lagi.${reset}"
    fi
done
until [[ $quota =~ ^[0-9]+$ ]]; do
    read -p "   Kuota Pengguna (GB): " quota
    if [[ -z "$quota" ]]; then
        echo -e "${red}Kuota tidak boleh kosong. Silakan coba lagi.${reset}"
    fi
done
until [[ $ip_limit =~ ^[0-9]+$ ]]; do
    read -p "   Batas IP Pengguna: " ip_limit
    if [[ -z "$ip_limit" ]]; then
        echo -e "${red}Batas IP tidak boleh kosong. Silakan coba lagi.${reset}"
    fi
done

# Function to send Telegram notification
send_telegram_notification() {
    local status="$1"
    local user="$2"
    local error_msg="$3"
    
    if [ -f '/root/.vars' ]; then
        source '/root/.vars'
        
    if [ "$status" == "success" ]; then
        message="
<b>ğŸš€ Alrescha79 Panel VPN ğŸš€</b>
<br>
<b>âœ… AKUN VLESS BERHASIL DIBUAT</b>
<br>
<b>ğŸ‘¤ Username:</b> <code>$user</code>
<b>ğŸ†” User ID:</b> <code>$uuid</code>
<b>ğŸŒ Host:</b> <code>$domain</code>
<b>ğŸ“ Location:</b> <code>$city</code>
<b>ğŸ”’ Port TLS:</b> <code>443</code>
<b>ğŸ”“ Port Non-TLS:</b> <code>80, 8080</code>
<b>ğŸ”§ Port GRPC:</b> <code>443</code>
<b>ğŸ” Security:</b> <code>auto</code>
<b>ğŸŒ Network:</b> <code>WS/gRPC</code>
<b>ğŸ“ Path:</b> <code>/whatever/vless</code>
<b>âš™ï¸ Service Name:</b> <code>vless-grpc</code>
<b>ğŸ“Š Quota:</b> <code>${quota} GB</code>
<b>ğŸ”¢ IP Limit:</b> <code>$ip_limit</code>
<b>â° Expires:</b> <code>$exp</code>
<br>
<b>ğŸ”— TLS Link:</b>
<code>$vless_tls</code>
<br>
<b>ğŸ”— Non-TLS Link:</b>
<code>$vless_non</code>
<br>
<b>ğŸ”— GRPC Link:</b>
<code>$vless_grpc</code>
<br>
<b>ğŸŒŸ Alrescha79 Panel VPN ğŸŒŸ</b>
"
    else
        message="
<b>ğŸš€ Alrescha79 Panel VPN ğŸš€</b>
<br>
<b>âŒ GAGAL MEMBUAT AKUN VLESS</b>
<br>
<b>ğŸ‘¤ Nama Pengguna:</b> <code>$user</code>
<b>ğŸ†” ID Pengguna:</b> <code>$uuid</code>
<b>ğŸŒ Host:</b> <code>$domain</code>
<b>â— Kesalahan:</b> <code>$error_msg</code>
<br>
<b>ğŸŒŸ Alrescha79 Panel VPN ğŸŒŸ</b>
"
        fi
        
        curl -s -X POST "https://api.telegram.org/bot$bot_token/sendMessage" \
            -d "chat_id=$telegram_id" \
            -d "parse_mode=HTML" \
            --data-urlencode "text=$message" > /dev/null 2>&1
    fi
}


# Account creation process
exp=$(date -d "$duration days" +"%Y-%m-%d")
if [ ! -f "/etc/xray/vless/config.json" ]; then
    echo -e "${red}File konfigurasi Vless tidak ditemukan. Membuat file baru...${reset}"
    mkdir -p /etc/xray/vless
    echo '{"inbounds": []}' >/etc/xray/vless/config.json
fi
if ! sed -i '/#vless$/a\### '"$user $exp"'\
},{"id": "'"$uuid"'","email": "'"$user"'"}' /etc/xray/vless/config.json; then
    echo -e "${red}Gagal menambahkan pengguna ke config.json${reset}"
    send_telegram_notification "error" "$user" "Gagal menambahkan pengguna ke config.json"
    exit 1
fi
if ! sed -i '/#vlessgrpc$/a\### '"$user $exp"'\
},{"id": "'"$uuid"'","email": "'"$user"'"}' /etc/xray/vless/config.json; then
    echo -e "${red}Gagal menambahkan pengguna ke config.json (GRPC)${reset}"
    send_telegram_notification "error" "$user" "Gagal menambahkan pengguna ke config.json (GRPC)"
    exit 1
fi

cat >/etc/xray/vless/$user-tls.json <<EOF
{
    "v": "2",
    "ps": "$user WS (CDN) TLS",
    "add": "${domain}",
    "port": "443",
    "id": "${uuid}",
    "aid": "0",
    "net": "ws",
    "path": "/whatever/vless",
    "type": "none",
    "host": "${domain}",
    "tls": "tls"
}
EOF

cat >/etc/xray/vless/$user-non.json <<EOF
{
    "v": "2",
    "ps": "$user WS (CDN) NTLS",
    "add": "${domain}",
    "port": "80",
    "id": "${uuid}",
    "aid": "0",
    "net": "ws",
    "path": "/whatever/vless",
    "type": "none",
    "host": "${domain}",
    "tls": "none"
}
EOF

cat >/etc/xray/vless/$user-grpc.json <<EOF
{
    "v": "2",
    "ps": "$user (SNI) GRPC",
    "add": "${domain}",
    "port": "443",
    "id": "${uuid}",
    "aid": "0",
    "net": "grpc",
    "path": "vless-grpc",
    "type": "none",
    "host": "${domain}",
    "tls": "tls"
}
EOF

# Create configuration file for OpenClash
cat >/var/www/html/vless-$user.txt <<-END
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Vless WS (CDN) Format
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: Vless-$user-WS (CDN)
  type: vless
  server: ${domain}
  port: 443
  uuid: ${uuid}
  cipher: auto
  udp: true
  tls: true
  skip-cert-verify: true
  servername: ${domain}
  network: ws
  ws-opts:
    path: /whatever/vless
    headers:
      Host: ${domain}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Vless WS (CDN) Non TLS Format
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: Vless-$user-WS (CDN) Non TLS
  type: vless
  server: ${domain}
  port: 80
  uuid: ${uuid}
  cipher: auto
  udp: true
  tls: false
  skip-cert-verify: false
  servername: ${domain}
  network: ws
  ws-opts:
    path: /whatever/vless
    headers:
      Host: ${domain}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Vless gRPC (SNI) Format
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: Vless-$user-gRPC (SNI)
  server: ${domain}
  port: 443
  type: vless
  uuid: ${uuid}
  cipher: auto
  network: grpc
  tls: true
  servername: ${domain}
  skip-cert-verify: true
  grpc-opts:
    grpc-service-name: vless-grpc

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Vless Account Links
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TLS Link : vless://${uuid}@${domain}:443?path=/whatever/vless&security=tls&encryption=none&host=${domain}&type=ws#${user}-WS-TLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Non-TLS Link : vless://${uuid}@${domain}:80?path=/whatever/vless&encryption=none&host=${domain}&type=ws#${user}-WS-NTLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
GRPC Link : vless://${uuid}@${domain}:443?mode=gun&security=tls&encryption=none&type=grpc&serviceName=vless-grpc&sni=${domain}#${user}-gRPC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

END

# Generate Vless links
vless_tls="vless://${uuid}@${domain}:443?path=/whatever/vless&security=tls&encryption=none&host=${domain}&type=ws#${user}-WS-TLS"
vless_non="vless://${uuid}@${domain}:80?path=/whatever/vless&encryption=none&host=${domain}&type=ws#${user}-WS-NTLS"
vless_grpc="vless://${uuid}@${domain}:443?mode=gun&security=tls&encryption=none&type=grpc&serviceName=vless-grpc&sni=${domain}#${user}-gRPC"

# Restart services
if ! systemctl restart vless@config >/dev/null 2>&1; then
    echo -e "${red}Gagal memulai ulang layanan Vless. Periksa log sistem untuk informasi lebih lanjut.${reset}"
    send_telegram_notification "error" "$user" "Gagal memulai ulang layanan Vless"
    exit 1
fi

# Exception if configuration file doesn't exist
if [ ! -f "/etc/xray/vless/config.json" ]; then
    echo "Peringatan: File konfigurasi Vless tidak ditemukan. Membuat file baru..."
    mkdir -p /etc/xray/vless
    echo '{"inbounds": []}' >/etc/xray/vless/config.json
    systemctl restart vless@config
fi

# Create directory if it doesn't exist
if [ ! -d "/etc/xray/vless" ]; then
    echo "Direktori /etc/xray/vless tidak ditemukan. Membuat direktori..."
    mkdir -p /etc/xray/vless
    if [ $? -ne 0 ]; then
        echo "Gagal membuat direktori /etc/xray/vless. Pastikan Anda memiliki izin yang cukup."
        exit 1
    fi
fi

# Set default values if empty
[ -z ${ip_limit} ] && ip_limit="0"
[ -z ${quota} ] && quota="0"

# Convert Quota to bytes
quota_bytes=$((${quota} * 1024 * 1024 * 1024))

# Save quota and IP limit data
if [[ ${quota} != "0" ]]; then
    echo "${quota_bytes}" >/etc/xray/vless/${user}
    echo "${ip_limit}" >/etc/xray/vless/${user}IP
fi

# Update database
db_file="/etc/xray/vless/.vless.db"
temp_file="/etc/xray/vless/.vless.db.tmp"

# Remove old entry if exists
if [ -f "$db_file" ]; then
    grep -v "^### ${user} " "$db_file" >"$temp_file"
    mv "$temp_file" "$db_file"
else
    touch "$db_file"
fi

# Add new entry
echo "### ${user} ${exp} ${uuid}" >>"$db_file"

# Send success notification to Telegram
send_telegram_notification "success" "$user"

# Save log
{
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "xray/vless account    "
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "description  : ${user}"
    echo "host server  : ${domain}"    
    echo "location     : $city"
    echo "port tls     : 443"
    echo "port non tls : 80, 8080"
    echo "port dns     : 443, 53"
    echo "port grpc    : 443"
    echo "security     : auto"
    echo "network      : ws or grpc"
    echo "path         : /whatever/vless"
    echo "servicename  : vless-grpc"
    echo "user id      : ${uuid}"
    echo "public key   : ${pubkey}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "tls link     : ${vless_tls}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "ntls link    : ${vless_non}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "grpc link    : ${vless_grpc}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "openclash format : https://${domain}:81/vless-$user.txt"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "expires on   : $exp"
    echo ""
} >> /etc/xray/vless/log-create-${user}.log

clear
# Display account information
clear 
echo -e "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "Xray/vless Account"
echo -e "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "Description  : ${user}"
echo -e "Host Server  : ${domain}"
echo -e "Location     : $city"
echo -e "Port TLS     : 443"
echo -e "Port non TLS : 80, 8080"
echo -e "Port DNS     : 443, 53"
echo -e "Port GRPC    : 443"
echo -e "Security     : auto"
echo -e "Network      : WS or gRPC"
echo -e "Path         : /whatever/vless "
echo -e "ServiceName  : vless-grpc"
echo -e "User ID      : ${uuid}"
echo -e "Public Key   : ${pubkey}"
echo -e "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "TLS Link    : ${vless_tls}"
echo -e "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "NTLS Link   : ${vless_non}"
echo -e "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "GRPC Link   : ${vless_grpc}"
echo -e "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "OpenClash Format : https://${domain}:81/vless-$user.txt"
echo -e "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "Expires On  : $exp"

