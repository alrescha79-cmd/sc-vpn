#!/bin/bash

# ===============================
# DEFINISI WARNA
# ===============================
green="\e[38;5;82m"
red="\e[38;5;196m"
neutral="\e[0m"
blue="\e[38;5;130m"
orange="\e[38;5;99m"
yellow="\e[38;5;226m"
purple="\e[38;5;141m"
bold_white="\e[1;37m"
reset="\e[0m"
pink="\e[38;5;205m"
magenta="\e[38;5;205m"
cyan="\e[38;5;87m"
bold="\e[1m"

# ===============================
# DAPATKAN IP DAN TANGGAL
# ===============================
ipsaya=$(curl -sS ipv4.icanhazip.com)
data_server=$(curl -v --insecure --silent https://google.com/ 2>&1 | grep Date | sed -e 's/< Date: //')
date_list=$(date +"%Y-%m-%d" -d "$data_server")

# ===============================
# AMBIL DATA CLIENT
# ===============================
MYIP=$ipsaya
url_izin="https://raw.githubusercontent.com/alrescha79-cmd/sc-vpn/refs/heads/dev/izin"
data_izin=$(curl -sS "$url_izin")
user_line=$(echo "$data_izin" | grep "$MYIP")

if [ -n "$user_line" ]; then
    username=$(echo "$user_line" | awk '{print $2}')
    valid=$(echo "$user_line" | awk '{print $3}')
else
    username=""
    valid=""
fi

echo "$username" >/usr/bin/user
echo "$valid" >/usr/bin/e

# ===============================
# FUNGSI VALIDASI MASA AKTIF
# ===============================
validate_access() {
    if [ -z "$username" ] || [ -z "$valid" ]; then
        clear
        echo -e "${red}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e "${red}â•‘                           AKSES DITOLAK                            â•‘${neutral}"
        echo -e "${red}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e ""
        echo -e " IP Anda (${MYIP}) tidak terdaftar dalam sistem"
        echo -e ""
        echo -e " Silakan hubungi administrator untuk mendapatkan akses:"
        echo -e " ğŸ“± Telegram: https://t.me/Alrescha79"
        echo -e " ğŸ“§ Email: anggun@cakson.my.id"
        echo -e ""
        echo -e "${red}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e " Tekan Enter untuk keluar..."
        read
        exit 1
    fi

    current_date=$(date +%Y-%m-%d)
    if [[ "$valid" < "$current_date" ]]; then
        expired_days=$(( ( $(date -d "$current_date" +%s) - $(date -d "$valid" +%s) ) / 86400 ))

        clear
        echo -e "${red}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e "${red}â•‘                        AKSES KADALUARSA                           â•‘${neutral}"
        echo -e "${red}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e ""
        echo -e " Masa aktif script Anda telah berakhir!"
        echo -e ""
        echo -e " Detail Akses:"
        echo -e "   â€¢ User ID      : ${username}"
        echo -e "   â€¢ IP Address   : ${MYIP}"
        echo -e "   â€¢ Tanggal Exp  : ${valid}"
        echo -e "   â€¢ Sudah Exp    : ${expired_days} hari"
        echo -e ""
        echo -e " Untuk memperpanjang masa aktif, hubungi:"
        echo -e " ğŸ“± Telegram: https://t.me/Alrescha79"
        echo -e " ğŸ“§ Email: anggun@cakson.my.id"
        echo -e " ğŸ’° Informasi Harga & Paket Tersedia"
        echo -e ""
        echo -e "${red}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e " Tekan Enter untuk keluar..."
        read
        exit 1
    fi
}

validate_access

convert_size() {
    local -i bytes=$1
    if [[ $bytes -lt 1024 ]]; then
        echo "${bytes}B"
    elif [[ $bytes -lt 1048576 ]]; then
        echo "$(((bytes + 1023) / 1024))KB"
    elif [[ $bytes -lt 1073741824 ]]; then
        echo "$(((bytes + 1048575) / 1048576))MB"
    else
        echo "$(((bytes + 1073741823) / 1073741824))GB"
    fi
}

print_rainbow() {
    local text="$1"
    local length=${#text}
    local start_color=(0 5 0)
    local mid_color=(0 200 0)
    local end_color=(0 5 0)

    for ((i = 0; i < length; i++)); do
        local progress=$((i * 100 / (length - 1)))

        if [ $progress -lt 50 ]; then
            local factor=$((progress * 2))
            r=$(((start_color[0] * (100 - factor) + mid_color[0] * factor) / 100))
            g=$(((start_color[1] * (100 - factor) + mid_color[1] * factor) / 100))
            b=$(((start_color[2] * (100 - factor) + mid_color[2] * factor) / 100))
        else
            local factor=$(((progress - 50) * 2))
            r=$(((mid_color[0] * (100 - factor) + end_color[0] * factor) / 100))
            g=$(((mid_color[1] * (100 - factor) + end_color[1] * factor) / 100))
            b=$(((mid_color[2] * (100 - factor) + end_color[2] * factor) / 100))
        fi

        printf "\e[38;2;%d;%d;%dm%s" "$r" "$g" "$b" "${text:$i:1}"
    done
    echo -e "$reset"
}

trojan_members() {
    clear
    echo -e "${orange}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    echo -e "${green}${bold_white}                     DAFTAR MEMBER TROJAN${neutral}"
    echo -e "${orange}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"

    if [ ! -e "/etc/xray/trojan/.trojan.db" ]; then
        echo -e "   ${red}Tidak ada akun Trojan yang terdaftar.${neutral}"
        echo -e "${orange}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
        echo -e ""
        display_trojan_menu
        return
    fi

    echo -e " Daftar Akun Trojan:"
    echo -e "Username         | Sisa   | Kuota     | IP    | Penggunaan | Status"
    echo -e "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    grep -E "^### " "/etc/xray/trojan/.trojan.db" | while read -r line; do
        user=$(echo "$line" | awk '{print $2}')
        exp=$(echo "$line" | awk '{print $3}')
        current_timestamp=$(date +%s)
        exp_timestamp=$(date -d "$exp" +%s)
        days_left=$(((exp_timestamp - current_timestamp) / 86400))

        if [ $days_left -lt 0 ]; then
            status_text="KADALUARSA"
            status_color="${red}"
            exp_display="${days_left}h"
        elif [ $days_left -le 3 ]; then
            status_text="SEGERA HABIS"
            status_color="${yellow}"
            exp_display="${days_left}h"
        else
            status_text="AKTIF"
            status_color="${green}"
            exp_display="${days_left}h"
        fi

        quota_file="/etc/xray/trojan/${user}"
        ip_limit_file="/etc/xray/trojan/${user}IP"
        usage_file="/etc/xray/trojan/usage/${user}"

        quota="Unlimited"
        if [ -f "$quota_file" ]; then
            quota_raw=$(cat "$quota_file")
            if [ -n "$quota_raw" ] && [ "$quota_raw" != "0" ]; then
                quota=$(convert_size "$quota_raw")
            fi
        fi

        ip_limit="Unlimited"
        if [ -f "$ip_limit_file" ]; then
            ip_limit_raw=$(cat "$ip_limit_file")
            if [ -n "$ip_limit_raw" ] && [ "$ip_limit_raw" != "0" ]; then
                ip_limit="$ip_limit_raw"
            fi
        fi

        usage="0B"
        if [ -f "$usage_file" ]; then
            usage_raw=$(cat "$usage_file")
            if [ -n "$usage_raw" ] && [ "$usage_raw" != "0" ]; then
                usage=$(convert_size "$usage_raw")
            fi
        fi

        printf "%-15s | %-6s | %-9s | %-4s | %-10s | " "$user" "$exp_display" "$quota" "$ip_limit" "$usage"
        echo -e "${status_color}${status_text}${neutral}"
    done

    total_count=$(grep -cE "^### " "/etc/xray/trojan/.trojan.db")
    echo -e "${orange}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    echo -e "${yellow}Total Akun Trojan : ${green}${total_count}${neutral}"
    echo -e "${orange}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    echo -e ""
    read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
    echo -e ""
    display_trojan_menu
}

change_trojan_limit() {
    clear
    echo -e "${orange}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    echo -e "${green}${bold_white}                     UBAH LIMIT TROJAN${neutral}"
    echo -e "${orange}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"

    if [ ! -e "/etc/xray/trojan/.trojan.db" ]; then
        echo -e "   ${red}Tidak ada akun Trojan yang terdaftar.${neutral}"
        echo -e "${orange}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
        echo -e ""
        display_trojan_menu
        return
    fi

    account_count=$(grep -cE "^### " "/etc/xray/trojan/.trojan.db")
    if [ $account_count -eq 0 ]; then
        echo -e "   ${red}Tidak ada akun Trojan yang aktif.${neutral}"
        echo -e "${orange}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
        echo -e ""
        display_trojan_menu
        return
    fi

    echo -e "No  | Username           | Sisa (hari)"
    echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    grep -E "^### " "/etc/xray/trojan/.trojan.db" | awk '{
        cmd = "date -d \"" $3 "\" +%s"
        cmd | getline exp_timestamp
        close(cmd)
        current_timestamp = systime()
        days_left = int((exp_timestamp - current_timestamp) / 86400)
        if (days_left < 0) days_left = 0
        printf "%-3d | %-18s | %-10s\n", NR, $2, days_left " hari"
    }'
    echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo -e ""
    read -p " Pilih nomor akun : " account_number

    if ! [[ "$account_number" =~ ^[0-9]+$ ]]; then
        echo -e "   ${red}Error: Input harus berupa angka.${neutral}"
        echo -e ""
        read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
        echo -e ""
        display_trojan_menu
        return
    fi

    if [ "$account_number" -lt 1 ] || [ "$account_number" -gt "$account_count" ]; then
        echo -e "   ${red}Error: Nomor akun tidak valid.${neutral}"
        echo -e ""
        read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
        echo -e ""
        display_trojan_menu
        return
    fi

    username=$(grep -E "^### " "/etc/xray/trojan/.trojan.db" | cut -d ' ' -f 2 | sed -n "${account_number}p")

    if [ -z "$username" ]; then
        echo -e "   ${red}Error: Nomor akun tidak ditemukan.${neutral}"
        echo -e ""
        read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
        echo -e ""
        display_trojan_menu
        return
    fi

    echo -e ""
    echo -e "Mengubah limit untuk akun: ${green}$username${neutral}"
    echo -e ""
    read -p "Masukkan limit kuota baru (dalam GB, 0 untuk unlimited): " new_quota
    read -p "Masukkan limit IP baru (0 untuk unlimited): " new_ip_limit

    if ! [[ "$new_quota" =~ ^[0-9]+$ ]]; then
        echo -e "${red}Error: Limit kuota harus berupa angka.${neutral}"
        echo -e ""
        read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
        echo -e ""
        display_trojan_menu
        return
    fi

    if ! [[ "$new_ip_limit" =~ ^[0-9]+$ ]]; then
        echo -e "${red}Error: Limit IP harus berupa angka.${neutral}"
        echo -e ""
        read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
        echo -e ""
        display_trojan_menu
        return
    fi

    new_quota_bytes=$((new_quota * 1024 * 1024 * 1024))

    echo "${new_quota_bytes}" >"/etc/xray/trojan/${username}"
    echo "${new_ip_limit}" >"/etc/xray/trojan/${username}IP"

    echo -e ""
    if [ $? -eq 0 ]; then
        echo -e "${green}Limit untuk akun $username berhasil diubah.${neutral}"
        echo -e " Kuota baru : ${new_quota} GB"
        echo -e " Limit IP   : ${new_ip_limit}"
    else
        echo -e "${red}Gagal mengubah limit untuk akun $username.${neutral}"
        echo -e "Pastikan Anda memiliki izin yang cukup dan coba lagi."
    fi

    echo -e ""
    echo -e "${orange}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
    echo -e ""
    display_trojan_menu
}

trojan_details() {
    clear
    echo -e "${orange}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    echo -e "${green}${bold_white}                      DETAIL AKUN TROJAN${neutral}"
    echo -e "${orange}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"

    if [ ! -e "/etc/xray/trojan/.trojan.db" ]; then
        echo -e "   ${red}Tidak ada akun Trojan yang terdaftar.${neutral}"
        echo -e "${orange}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
        echo -e ""
        display_trojan_menu
        return
    fi

    echo -e ""

    account_counter=1
    while IFS= read -r line; do
        [[ $line != "### "* ]] && continue

        user=$(echo "$line" | awk '{print $2}')
        exp=$(echo "$line" | awk '{print $3}')
        uuid=$(echo "$line" | awk '{print $4}')

        current_timestamp=$(date +%s)
        exp_timestamp=$(date -d "$exp" +%s)
        days_left=$(((exp_timestamp - current_timestamp) / 86400))

        if [ $days_left -lt 0 ]; then
            status="${red}KADALUARSA${neutral}"
            exp_display="$exp (${days_left} hari)"
        elif [ $days_left -le 3 ]; then
            status="${yellow}SEGERA HABIS${neutral}"
            exp_display="$exp (${days_left} hari)"
        else
            status="${green}AKTIF${neutral}"
            exp_display="$exp (${days_left} hari)"
        fi

        echo -e "${yellow}â•â•â• AKUN #${account_counter} â•â•â•${neutral}"
        echo -e "   Username      : ${green}$user${neutral}"
        echo -e "   Tanggal Exp   : ${green}$exp_display${neutral}"
        echo -e "   Status        : $status"
        echo -e "   Password/UUID : ${green}$uuid${neutral}"

        quota_file="/etc/xray/trojan/${user}"
        ip_limit_file="/etc/xray/trojan/${user}IP"
        usage_file="/etc/xray/trojan/usage/${user}"

        if [ -f "$quota_file" ]; then
            quota_raw=$(cat "$quota_file")
            if [ -n "$quota_raw" ] && [ "$quota_raw" != "0" ]; then
                quota_readable=$(convert_size "$quota_raw")
                echo -e "   Kuota         : ${green}$quota_readable${neutral}"
            else
                echo -e "   Kuota         : ${green}Unlimited${neutral}"
            fi
        else
            echo -e "   Kuota         : ${green}Unlimited${neutral}"
        fi

        if [ -f "$ip_limit_file" ]; then
            ip_limit=$(cat "$ip_limit_file")
            if [ -n "$ip_limit" ] && [ "$ip_limit" != "0" ]; then
                echo -e "   Limit IP      : ${green}$ip_limit${neutral}"
            else
                echo -e "   Limit IP      : ${green}Unlimited${neutral}"
            fi
        else
            echo -e "   Limit IP      : ${green}Unlimited${neutral}"
        fi

        if [ -f "$usage_file" ]; then
            usage_raw=$(cat "$usage_file")
            if [ -n "$usage_raw" ] && [ "$usage_raw" != "0" ]; then
                usage_readable=$(convert_size "$usage_raw")
                echo -e "   Penggunaan    : ${green}$usage_readable${neutral}"
            else
                echo -e "   Penggunaan    : ${green}0B${neutral}"
            fi
        else
            echo -e "   Penggunaan    : ${green}0B${neutral}"
        fi

        echo -e "${orange}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${neutral}"
        ((account_counter++))
    done <"/etc/xray/trojan/.trojan.db"

    echo -e ""
    read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
    echo -e ""
    display_trojan_menu
}

custom_uuid_trojan() {
    clear
    echo -e "${orange}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    echo -e "${green}${bold_white}                     CUSTOM UUID TROJAN${neutral}"
    echo -e "${orange}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"

    if [ ! -e "/etc/xray/trojan/.trojan.db" ]; then
        echo -e "   ${red}Tidak ada akun Trojan yang terdaftar.${neutral}"
        echo -e "${orange}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
        echo -e ""
        display_trojan_menu
        return
    fi

    account_count=$(grep -cE "^### " "/etc/xray/trojan/.trojan.db")
    if [ $account_count -eq 0 ]; then
        echo -e "   ${red}Tidak ada akun Trojan yang aktif.${neutral}"
        echo -e "${orange}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
        echo -e ""
        display_trojan_menu
        return
    fi

    echo -e "No  | Username           | Sisa (hari)"
    echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    grep -E "^### " "/etc/xray/trojan/.trojan.db" | awk '{
        cmd = "date -d \"" $3 "\" +%s"
        cmd | getline exp_timestamp
        close(cmd)
        current_timestamp = systime()
        days_left = int((exp_timestamp - current_timestamp) / 86400)
        if (days_left < 0) days_left = 0
        printf "%-3d | %-18s | %-10s\n", NR, $2, days_left " hari"
    }'
    echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo -e ""
    read -p " Pilih nomor akun : " account_number

    if ! [[ "$account_number" =~ ^[0-9]+$ ]]; then
        echo -e "   ${red}Error: Input harus berupa angka.${neutral}"
        echo -e ""
        read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
        echo -e ""
        display_trojan_menu
        return
    fi

    if [ "$account_number" -lt 1 ] || [ "$account_number" -gt "$account_count" ]; then
        echo -e "   ${red}Error: Nomor akun tidak valid.${neutral}"
        echo -e ""
        read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
        echo -e ""
        display_trojan_menu
        return
    fi

    user=$(grep -E "^### " "/etc/xray/trojan/.trojan.db" | cut -d ' ' -f 2 | sed -n "${account_number}p")

    if [ -z "$user" ]; then
        echo -e "   ${red}Error: Nomor akun tidak ditemukan.${neutral}"
        echo -e ""
        read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
        echo -e ""
        display_trojan_menu
        return
    fi

    echo -e ""
    echo -e "Mengubah UUID untuk akun: ${green}$user${neutral}"
    echo -e ""
    while true; do
        read -p " Masukkan UUID baru (minimal 6 karakter): " new_uuid
        if [[ ${#new_uuid} -ge 6 && "$new_uuid" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            break
        fi
        printf "\033[1A\033[0J"
        echo -e "${red} UUID harus minimal 6 karakter dan hanya mengandung huruf, angka, _ atau -${neutral}"
    done

    if [ -z "$new_uuid" ]; then
        echo -e "${red}Error: UUID tidak boleh kosong.${neutral}"
        echo -e ""
        read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
        echo -e ""
        display_trojan_menu
        return
    fi

    user_data=$(grep "^### $user" /etc/xray/trojan/.trojan.db)
    exp=$(echo "$user_data" | awk '{print $3}')
    config_file="/etc/xray/trojan/config.json"
    db_file="/etc/xray/trojan/.trojan.db"

    if [ ! -f "$config_file" ] || [ ! -f "$db_file" ]; then
        echo -e "${red}Error: Berkas konfigurasi Trojan tidak ditemukan.${neutral}"
        echo -e " Pastikan layanan Trojan sudah terpasang dengan benar."
        echo -e ""
        read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
        echo -e ""
        display_trojan_menu
        return
    fi

    if [ -z "$exp" ]; then
        echo -e "${red}Error: Gagal menemukan data masa aktif akun.${neutral}"
        echo -e " Data akun mungkin sudah tidak valid."
        echo -e ""
        read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
        echo -e ""
        display_trojan_menu
        return
    fi

    tmp_config=$(mktemp)
    if ! awk -v user="$user" -v exp="$exp" '
        $0 == ("### " user " " exp) {getline; next}
        {print}
    ' "$config_file" >"$tmp_config"; then
        rm -f "$tmp_config"
        echo -e "${red}Error: Gagal memperbarui konfigurasi Trojan.${neutral}"
        echo -e " Coba lagi beberapa saat atau periksa berkas konfigurasi."
        echo -e ""
        read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
        echo -e ""
        display_trojan_menu
        return
    fi

    mv "$tmp_config" "$config_file"

    if ! sed -i '/#trojan$/a\\### '"$user $exp"'\\
},{"password": "'"$new_uuid"'","email": "'"$user"'"' "$config_file"; then
        echo -e "${red}Error: Gagal menambahkan UUID baru ke konfigurasi Trojan.${neutral}"
        echo -e ""
        read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
        echo -e ""
        display_trojan_menu
        return
    fi

    if ! sed -i '/#trojangrpc$/a\\### '"$user $exp"'\\
},{"password": "'"$new_uuid"'","email": "'"$user"'"' "$config_file"; then
        echo -e "${red}Error: Gagal menambahkan UUID baru ke konfigurasi Trojan gRPC.${neutral}"
        echo -e ""
        read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
        echo -e ""
        display_trojan_menu
        return
    fi

    sed -i "/^### $user /d" "$db_file"
    echo "### $user $exp $new_uuid" >>"$db_file"

    if systemctl restart trojan@config >/dev/null 2>&1; then
        echo -e "${green}UUID untuk akun ${user} berhasil diperbarui.${neutral}"
    else
        echo -e "${yellow}UUID untuk akun ${user} telah diperbarui, namun layanan Trojan gagal direstart.${neutral}"
        echo -e " Silakan cek status layanan secara manual."
    fi

    echo -e ""
    echo -e "${orange}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    read -n 1 -s -r -p "Tekan [ Enter ] untuk kembali ke menu..."
    echo -e ""
    display_trojan_menu
}
# Function to display Trojan menu
display_trojan_menu() {
    clear
    echo -e ""
    echo -e "${magenta}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${neutral}"
    echo -e "${magenta}â•‘                              ${blue}MANAJEMEN TROJAN${magenta}                       â•‘${neutral}"
    echo -e "${magenta}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    echo -e ""
    echo -e "${cyan}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${neutral}"
    echo -e "${cyan}â•‘                               ${blue}PILIHAN MENU${cyan}                           â•‘${neutral}"
    echo -e "${cyan}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${neutral}"
    echo -e ""
    echo -e "   ${neutral} ${green}[1]${neutral}  Buat Akun Trojan           ${green}[6]${neutral} Ubah Limit   "
    echo -e "   ${neutral} ${green}[2]${neutral}  Hapus Akun Trojan          ${green}[7]${neutral} Detail Akun  "
    echo -e "   ${neutral} ${green}[3]${neutral}  Perpanjang Trojan          ${green}[8]${neutral} Trial Trojan "
    echo -e "   ${neutral} ${green}[4]${neutral}  Cek User Login             ${green}[9]${neutral} Custom UUID  "
    echo -e "   ${neutral} ${green}[5]${neutral}  List Member Trojan         ${red}[x]${neutral}  Kembali ke Menu Utama"
    echo -e ""
    echo -e "${cyan}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    echo -e ""
    echo -ne "${yellow}Pilih menu [1-9 atau x]: ${neutral}"
    read trojan_choice

    case $trojan_choice in
    1) addtrojan ;;
    2) delltrojan ;;
    3) renewtrojan ;;
    4) checktrojan ;;
    5) trojan_members ;;
    6) change_trojan_limit ;;
    7) trojan_details ;;
    8) trialtrojan ;;
    9) custom_uuid_trojan ;;
    x | X)
        echo -e ""
        echo -e "${green}Kembali ke menu utama...${neutral}"
        menu
        ;;
    *)
        echo -e ""
        echo -e "${red}Pilihan tidak valid! Silahkan pilih menu yang tersedia.${neutral}"
        echo -e "${yellow}Tekan Enter untuk mencoba lagi...${neutral}"
        read
        display_trojan_menu
        ;;
    esac
}

# Call function to display menu
display_trojan_menu
