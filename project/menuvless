#!/bin/bash

# ===============================
# DAPATKAN IP DAN TANGGAL
# ===============================
ipsaya=$(curl -sS ipv4.icanhazip.com)
data_server=$(curl -v --insecure --silent https://google.com/ 2>&1 | grep Date | sed -e 's/< Date: //')
date_list=$(date +"%Y-%m-%d" -d "$data_server")

# ===============================
# AMBIL DATA CLIENT 
# ===============================
MYIP=$ipsaya

# URL data izin
url_izin="https://raw.githubusercontent.com/alrescha79-cmd/sc-vpn/refs/heads/dev/izin"

# Ambil data dari GitHub dengan format baru: ### User Date IP
data_izin=$(curl -sS "$url_izin")
user_line=$(echo "$data_izin" | grep "$MYIP")

if [ -n "$user_line" ]; then
    username=$(echo "$user_line" | awk '{print $2}')
    valid=$(echo "$user_line" | awk '{print $3}')
else
    username=""
    valid=""
fi

echo "$username" >/usr/bin/user
echo "$valid" >/usr/bin/e

# ===============================
# FUNGSI VALIDASI MASA AKTIF
# ===============================
validate_access() {
    # Cek jika data user tidak ditemukan
    if [ -z "$username" ] || [ -z "$valid" ]; then
        clear
        echo -e "${red}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e "${red}â•‘                           AKSES DITOLAK                            â•‘${neutral}"
        echo -e "${red}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e ""
        echo -e " IP Anda (${MYIP}) tidak terdaftar dalam sistem"
        echo -e ""
        echo -e " Silakan hubungi administrator untuk mendapatkan akses:"
        echo -e " ğŸ“± Telegram: https://t.me/Alrescha79"
        echo -e " ğŸ“§ Email: anggun@cakson.my.id"
        echo -e ""
        echo -e "${red}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e " Tekan Enter untuk keluar..."
        read
        exit 1
    fi
    
    # Cek masa aktif
    current_date=$(date +%Y-%m-%d)
    if [[ "$valid" < "$current_date" ]]; then
        # Hitung berapa hari sudah expired
        expired_days=$(( ( $(date -d "$current_date" +%s) - $(date -d "$valid" +%s) ) / 86400 ))
        
        clear
        echo -e "${red}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e "${red}â•‘                        AKSES KADALUARSA                           â•‘${neutral}"
        echo -e "${red}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e ""
        echo -e " Akses untuk IP Anda telah kadaluarsa!"
        echo -e ""
        echo -e " Detail Akses:"
        echo -e "   â€¢ User ID: ${username}"
        echo -e "   â€¢ IP Address: ${MYIP}"
        echo -e "   â€¢ Tanggal Kadaluarsa: ${valid}"
        echo -e "   â€¢ Sudah Expired: ${expired_days} hari"
        echo -e ""
        echo -e " Untuk memperpanjang masa aktif, hubungi:"
        echo -e " ğŸ“± Telegram: https://t.me/Alrescha79"
        echo -e " ğŸ“§ Email: anggun@cakson.my.id"
        echo -e " ğŸ’° Informasi Harga & Paket Tersedia"
        echo -e ""
        echo -e "${red}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e " Tekan Enter untuk keluar..."
        read
        exit 1
    fi
}

# Panggil fungsi validasi sebelum menampilkan menu
validate_access
MYIP=$ipsaya

# URL data izin
url_izin="https://raw.githubusercontent.com/alrescha79-cmd/sc-vpn/refs/heads/dev/izin"

# Ambil data dari GitHub dengan format baru: ### User Date IP
data_izin=$(curl -sS "$url_izin")
user_line=$(echo "$data_izin" | grep "$MYIP")

if [ -n "$user_line" ]; then
    username=$(echo "$user_line" | awk '{print $2}')
    valid=$(echo "$user_line" | awk '{print $3}')
else
    username=""
    valid=""
fi

echo "$username" >/usr/bin/user
echo "$valid" >/usr/bin/e

# ===============================
# FUNGSI VALIDASI MASA AKTIF
# ===============================
validate_access() {
    # Cek jika data user tidak ditemukan
    if [ -z "$username" ] || [ -z "$valid" ]; then
        clear
        echo -e "${red}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e "${red}â•‘                           AKSES DITOLAK                            â•‘${neutral}"
        echo -e "${red}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e ""
        echo -e " IP Anda (${MYIP}) tidak terdaftar dalam sistem"
        echo -e ""
        echo -e " Silakan hubungi administrator untuk mendapatkan akses:"
        echo -e " ğŸ“± Telegram: https://t.me/Alrescha79"
        echo -e " ğŸ“§ Email: anggun@cakson.my.id"
        echo -e ""
        echo -e "${red}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e " Tekan Enter untuk keluar..."
        read
        exit 1
    fi
    
    # Cek masa aktif
    current_date=$(date +%Y-%m-%d)
    if [[ "$valid" < "$current_date" ]]; then
        # Hitung berapa hari sudah expired
        expired_days=$(( ( $(date -d "$current_date" +%s) - $(date -d "$valid" +%s) ) / 86400 ))
        
        clear
        echo -e "${red}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e "${red}â•‘                        AKSES KADALUARSA                           â•‘${neutral}"
        echo -e "${red}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e ""
        echo -e " Masa aktif script Anda telah berakhir!"
        echo -e ""
        echo -e " Detail Akses:"
        echo -e "   â€¢ User ID: ${username}"
        echo -e "   â€¢ IP Address: ${MYIP}"
        echo -e "   â€¢ Tanggal Kadaluarsa: ${valid}"
        echo -e "   â€¢ Sudah Expired: ${expired_days} hari"
        echo -e ""
        echo -e " Untuk memperpanjang masa aktif, hubungi:"
        echo -e " ğŸ“± Telegram: https://t.me/Alrescha79"
        echo -e " ğŸ“§ Email: anggun@cakson.my.id"
        echo -e " ğŸ’° Informasi Harga & Paket Tersedia"
        echo -e ""
        echo -e "${red}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e " Tekan Enter untuk keluar..."
        read
        exit 1
    fi
}

# Panggil fungsi validasi sebelum menampilkan menu
validate_access


    
# Variables
green="\e[38;5;87m"
        red="\e[38;5;196m"
        neutral="\e[0m"
        blue="\e[38;5;130m"
        orange="\e[38;5;99m"
        yellow="\e[38;5;226m"
        purple="\e[38;5;141m"
        bold_white="\e[1;37m"
        reset="\e[0m"
        pink="\e[38;5;205m"

convert_size() {
    local -i bytes=$1
    if [[ $bytes -lt 1024 ]]; then
        echo "${bytes}B"
    elif [[ $bytes -lt 1048576 ]]; then
        echo "$(((bytes + 1023) / 1024))KB"
    elif [[ $bytes -lt 1073741824 ]]; then
        echo "$(((bytes + 1048575) / 1048576))MB"
    else
        echo "$(((bytes + 1073741823) / 1073741824))GB"
    fi
}

# Function to print rainbow text
        print_rainbow() {
            local text="$1"
            local length=${#text}
            local start_color=(0 5 0)
            local mid_color=(0 200 0)
            local end_color=(0 5 0)

            for ((i = 0; i < length; i++)); do
                local progress=$((i * 100 / (length - 1)))

                if [ $progress -lt 50 ]; then
                    local factor=$((progress * 2))
                    r=$(( (start_color[0] * (100 - factor) + mid_color[0] * factor) / 100 ))
                    g=$(( (start_color[1] * (100 - factor) + mid_color[1] * factor) / 100 ))
                    b=$(( (start_color[2] * (100 - factor) + mid_color[2] * factor) / 100 ))
                else
                    local factor=$(((progress - 50) * 2))
                    r=$(( (mid_color[0] * (100 - factor) + end_color[0] * factor) / 100 ))
                    g=$(( (mid_color[1] * (100 - factor) + end_color[1] * factor) / 100 ))
                    b=$(( (mid_color[2] * (100 - factor) + end_color[2] * factor) / 100 ))
                fi

                printf "\e[38;2;%d;%d;%dm%s" "$r" "$g" "$b" "${text:$i:1}"
            done
            echo -e "$reset" # Reset color at the end
        }
vless_members() {
    clear
    echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    echo -e "${green}â•‘                           VLESS MEMBERS                           â•‘${neutral}"
    echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    if [ ! -e "/etc/xray/vless/.vless.db" ]; then
        echo -e "   ${red}No VLESS accounts registered.${neutral}"
        echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e "   Press enter to return to the menu"
        read
        return
    fi

    echo -e " List of VLESS Accounts:"
    echo "â”Œâ”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”"
    echo "â”‚noâ”‚ username   â”‚ exp  â”‚quota â”‚ip â”‚usage â”‚"
    echo "â”œâ”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤"

    grep -E "^### " "/etc/xray/vless/.vless.db" | nl -s ' ' | while read -r line; do
        no=$(echo "$line" | awk '{print $1}')
        user=$(echo "$line" | awk '{print $3}')
        exp=$(echo "$line" | awk '{print $4}')
        current_timestamp=$(date +%s)
        exp_timestamp=$(date -d "$exp" +%s)
        days_left=$(( (exp_timestamp - current_timestamp) / 86400 ))
        if [ $days_left -lt 0 ]; then
            days_left=0
        fi
        exp="${days_left}d"

        quota_file="/etc/xray/vless/${user}"
        ip_limit_file="/etc/xray/vless/${user}IP"
        usage_file="/etc/xray/vless/usage/${user}"

        quota="Unltd"
        if [ -f "$quota_file" ]; then
            quota=$(cat "$quota_file")
            if [ "$quota" != "" ] && [ "$quota" != "0" ]; then
                quota=$(convert_size "$quota")
            else
                quota="Unltd"
            fi
        fi

        ip_limit="Unltd"
        if [ -f "$ip_limit_file" ]; then
            ip_limit=$(cat "$ip_limit_file")
            if [ "$ip_limit" = "" ] || [ "$ip_limit" = "0" ]; then
                ip_limit="Unltd"
            fi
        fi

        usage="0GB"
        if [ -f "$usage_file" ]; then
            usage=$(cat "$usage_file")
            if [ "$usage" != "" ] && [ "$usage" != "0" ]; then
                usage=$(convert_size "$usage")
            else
                usage="0GB"
            fi
        fi

        printf "â”‚%-2sâ”‚%-12sâ”‚%-6sâ”‚%-6sâ”‚%-3sâ”‚%-6sâ”‚\n" "$no" "$user" "$exp" "$quota" "$ip_limit" "$usage"
    done
    echo "â””â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜"

    echo -e ""
    echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    echo -e " Tekan Enter untuk kembali ke menu..."
    read

}
change_vless_limit() {
    clear
    echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    echo -e "${green}â•‘                        CHANGE VLESS LIMIT                         â•‘${neutral}"
    echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"


    if [ ! -e "/etc/xray/vless/.vless.db" ]; then
        echo -e "   ${red}No VLESS accounts registered.${neutral}"
        echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e "   Press enter to return to the menu"
        read
        return
    fi
   echo -e " List of VLESS Accounts:"
    echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    account_count=$(grep -cE "^### " "/etc/xray/vless/.vless.db")
    if [ $account_count -eq 0 ]; then
        echo -e "   ${red}No active VLESS accounts.${neutral}"
        echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e "   Press enter to return to the menu"
        read
        return
    fi
    echo "â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo "â”‚ no â”‚ username           â”‚     exp     â”‚"
    echo "â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
    grep -E "^### " "/etc/xray/vless/.vless.db" | awk '{
        cmd = "date -d \"" $3 "\" +%s"
        cmd | getline exp_timestamp
        close(cmd)
        current_timestamp = systime()
        days_left = int((exp_timestamp - current_timestamp) / 86400)
        if (days_left < 0) days_left = 0
        printf "â”‚ %-2d â”‚ %-18s â”‚ %-11s â”‚\n", NR, $2, days_left " days"
    }'
    echo "â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

    echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    read -p "   Select the account number : " account_number
    
    # Check if input is a number
    if ! [[ "$account_number" =~ ^[0-9]+$ ]]; then
        echo -e "   ${red}Error: Input must be a number.${neutral}"
        echo -e "   Press enter to return to the menu"
        read
        return
    fi
    
    # Check if account number is valid
    if [ "$account_number" -lt 1 ] || [ "$account_number" -gt "$account_count" ]; then
        echo -e "   ${red}Error: Invalid account number.${neutral}"
        echo -e "   Press enter to return to the menu"
        read
        return
    fi

    username=$(grep -E "^### " "/etc/xray/vless/.vless.db" | cut -d ' ' -f 2 | sed -n "${account_number}p")

    if [ -z "$username" ]; then
        echo -e "   ${red}Invalid account number.${neutral}"
        echo -e "   Tekan Enter untuk kembali ke menu..."
        read
        return
    fi

    echo -e "Changing limit for account: ${green}$username${neutral}"
    read -p "Enter new quota limit (in GB, 0 for unlimited): " new_quota
    read -p "Enter new IP limit (0 for unlimited): " new_ip_limit

    # Validate input
    if ! [[ "$new_quota" =~ ^[0-9]+$ ]]; then
        echo -e "${red}Error: Quota limit must be a number.${neutral}"
        echo -e "   Press enter to return to the menu"
        read
        return
    fi

    if ! [[ "$new_ip_limit" =~ ^[0-9]+$ ]]; then
        echo -e "${red}Error: IP limit must be a number.${neutral}"
        echo -e "   Press enter to return to the menu"
        read
        return
    fi

    # Convert quota to bytes
    new_quota_bytes=$((new_quota * 1024 * 1024 * 1024))

    # Update quota and IP limit files
    echo "${new_quota_bytes}" >"/etc/xray/vless/${username}"
    echo "${new_ip_limit}" >"/etc/xray/vless/${username}IP"

    # Check if update was successful
    if [ $? -eq 0 ]; then
        echo -e "${green}Limit for account $username successfully changed.${neutral}"
        echo -e "New quota: ${new_quota} GB"
        echo -e "New IP limit: ${new_ip_limit}"
    else
        echo -e "${red}Failed to change limit for account $username.${neutral}"
        echo -e "Please ensure you have sufficient permissions and try again."
    fi

    echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    echo -e "   Tekan Enter untuk kembali ke menu..."
    read
}
vless_details() {
    clear
    echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    echo -e "${green}â•‘                           VLESS DETAIL                            â•‘${neutral}"
    echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"

    if [ ! -e "/etc/xray/vless/.vless.db" ]; then
        echo -e "   ${red}No VLESS accounts registered.${neutral}"
        echo -e "   ${orange}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${neutral}"
        echo -e "   Tekan Enter untuk kembali ke menu..."
        read
        return
    fi

    echo -e " List of VLESS Accounts:"
    echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"

    while IFS= read -r line; do
        user=$(echo $line | cut -d ' ' -f 2 | sort -u)
        exp=$(echo $line | cut -d ' ' -f 3 | sort -u)
        uuid=$(echo $line | cut -d ' ' -f 4 | sort -u)

        echo -e "   Username      : ${green}$user${neutral}"
        echo -e "   Expired Date  : ${green}$exp${neutral}"
        echo -e "   UUID          : ${green}$uuid${neutral}"

        if [ -f "/etc/xray/vless/${user}" ]; then
            quota=$(cat /etc/xray/vless/${user})
            if [ -n "$quota" ] && [ "$quota" != "0" ]; then
                quota_readable=$(convert_size $quota)
                echo -e "   Quota         : ${green}$quota_readable${neutral}"
            else
                echo -e "   Quota         : ${green}Unlimited${neutral}"
            fi
        else
            echo -e "   Quota         : ${green}Unlimited${neutral}"
        fi

        if [ -f "/etc/xray/vless/${user}IP" ]; then
            ip_limit=$(cat /etc/xray/vless/${user}IP)
            if [ -n "$ip_limit" ] && [ "$ip_limit" != "0" ]; then
                echo -e "   IP Limit      : ${green}$ip_limit${neutral}"
            else
                echo -e "   IP Limit      : ${green}Unlimited${neutral}"
            fi
        else
            echo -e "   IP Limit      : ${green}Unlimited${neutral}"
        fi

        echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    done <"/etc/xray/vless/.vless.db"

    echo -e "   Tekan Enter untuk kembali ke menu..."
    read
}
custom_vless_uuid() {
    clear
    echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    echo -e "${green}â•‘                        CUSTOM VLESS UUID                          â•‘${neutral}"
    echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"


    if [ ! -e "/etc/xray/vless/.vless.db" ]; then
        echo -e "   ${red}No VLESS accounts registered.${neutral}"
        echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e "   Press enter to return to the menu"
        read
        return
    fi

    account_count=$(grep -cE "^### " "/etc/xray/vless/.vless.db")
    if [ $account_count -eq 0 ]; then
        echo -e "   ${red}No active VLESS accounts.${neutral}"
        echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
        echo -e "   Press enter to return to the menu"
        read
        return
    fi
    echo -e " List of VLESS Accounts:"
    echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    echo "â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo "â”‚ no â”‚ username           â”‚     exp     â”‚"
    echo "â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
    grep -E "^### " "/etc/xray/vless/.vless.db" | awk '{
        cmd = "date -d \"" $3 "\" +%s"
        cmd | getline exp_timestamp
        close(cmd)
        current_timestamp = systime()
        days_left = int((exp_timestamp - current_timestamp) / 86400)
        if (days_left < 0) days_left = 0
        printf "â”‚ %-2d â”‚ %-18s â”‚ %-11s â”‚\n", NR, $2, days_left " days"
    }'
    echo "â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

    echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    read -p "   Select the account number : " account_number
    
    # Check if input is a number
    if ! [[ "$account_number" =~ ^[0-9]+$ ]]; then
        echo -e "   ${red}Error: Input must be a number.${neutral}"
        echo -e "   Press enter to return to the menu"
        read
        return
    fi
    
    # Check if account number is valid
    if [ "$account_number" -lt 1 ] || [ "$account_number" -gt "$account_count" ]; then
        echo -e "   ${red}Error: Invalid account number.${neutral}"
        echo -e "   Press enter to return to the menu"
        read
        return
    fi

    user=$(grep -E "^### " "/etc/xray/vless/.vless.db" | cut -d ' ' -f 2 | sed -n "${account_number}p")

    if [ -z "$user" ]; then
        echo -e "   ${red}Invalid account number.${neutral}"
        echo -e "   Tekan Enter untuk kembali ke menu..."
        read
        return
    fi
    while true; do
        read -p "   UUID (min 6 characters): " new_uuid
        if [[ ${#new_uuid} -ge 6 && "$new_uuid" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            break
        else
            printf "\033[1A\033[0J"
            echo -e "${red}   UUID must be at least 6 characters${neutral}"
        fi
    done

    if [ -z "$new_uuid" ]; then
        echo -e "${red}Error: UUID cannot be empty.${neutral}"
        echo -e "   Tekan Enter untuk kembali ke menu..."
        read
        return
    fi
    # Update UUID in config.json
    user_data=$(cat /etc/xray/vless/.vless.db | grep "^### $user")
    exp=$(echo "$user_data" | awk '{print $3}')
    config_file="/etc/xray/vless/config.json"
    db_file="/etc/xray/vless/.vless.db"

    sed -i "/^### $user $exp/,/^},{/d" "$config_file"

    # Add configuration back to config_file
    sed -i '/#vless$/a\### '"$user $exp"'\
},{"id": "'""$new_uuid""'","email": "'""$user""'"'  "$config_file"

    sed -i '/#vlessgrpc$/a\### '"$user $exp"'\
},{"id": "'""$new_uuid""'","email": "'""$user""'"'  "$config_file"
  
    sed -i "/^### $user/d" "$db_file"
    echo "### $user $exp $new_uuid" >> "$db_file"
    systemctl restart vless@config
    if [ $? -eq 0 ]; then
        echo -e "UUID for account $user successfully changed.${neutral}"
    else
        echo -e "UUID for account ${green}$user${neutral} successfully changed."
        echo -e "Please ensure you have sufficient permissions and try again."
    fi

    echo -e "${green}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    echo -e "   Tekan Enter untuk kembali ke menu..."
    read
}
# Function to display VLESS menu
display_vless_menu() {
    clear
    echo -e ""
    echo -e "${magenta}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${neutral}"
    echo -e "${magenta}â•‘                              ${cyan}VLESS MANAGEMENT${magenta}                       â•‘${neutral}"
    echo -e "${magenta}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    echo -e ""
    echo -e "${cyan}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${neutral}"
    echo -e "${cyan}â•‘                               ${blue}PILIHAN MENU${cyan}                           â•‘${neutral}"
    echo -e "${cyan}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${neutral}"
    echo -e ""
    echo -e "   ${neutral} ${green}[1]${neutral}  Buat Akun Vless           ${green}[6]${neutral} Ubah Limit   "
    echo -e "   ${neutral} ${green}[2]${neutral}  Hapus Akun Vless          ${green}[7]${neutral} Detail Akun  "
    echo -e "   ${neutral} ${green}[3]${neutral}  Perpanjang Vless          ${green}[8]${neutral} Trial Vless "
    echo -e "   ${neutral} ${green}[4]${neutral}  Cek User Login            ${green}[9]${neutral} Custom UUID  "
    echo -e "   ${neutral} ${green}[5]${neutral}  List Member Vless         ${red}[x]${neutral}  Kembali ke Menu Utama"
    echo -e ""
    echo -e "${cyan}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${neutral}"
    echo -e ""
    echo -ne "${yellow}Pilih menu [1-9 atau x]: ${neutral}"
    read vless_choice

    case $vless_choice in
    1) addvless ;;
    2) dellvless ;;
    3) renewvless ;;
    4) checkvless ;;
    5) vless_members ;;
    6) change_vless_limit ;;
    7) vless_details ;;
    8) trialvless ;;
    9) custom_vless_uuid ;;
    x | X)
        echo -e ""
        echo -e "${green}Kembali ke menu utama...${neutral}"
        menu
        ;;
    *)
        echo -e ""
        echo -e "${red}Pilihan tidak valid! Silahkan pilih menu yang tersedia.${neutral}"
        echo -e "${yellow}Tekan Enter untuk mencoba lagi...${neutral}"
        read
        display_vless_menu
        ;;
    esac
}

# Call function to display menu
display_vless_menu
