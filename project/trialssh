#!/bin/bash

# Valid Script
ipsaya=$(curl -sS ipv4.icanhazip.com)
data_server=$(curl -v --insecure --silent https://google.com/ 2>&1 | grep Date | sed -e 's/< Date: //')
date_list=$(date +"%Y-%m-%d" -d "$data_server")


    
# Colors
red="\e[91m"
green="\e[92m"
yellow="\e[93m"
blue="\e[94m"
purple="\e[95m"
cyan="\e[96m"
white="\e[97m"
reset="\e[0m"

# Function to print rainbow text
print_rainbow() {
    local text="$1"
    local length=${#text}
    local start_color=(255 255 0) # yellow
    local mid_color=(0 255 0)     # green
    local end_color=(255 255 0)   # yellow

    for ((i = 0; i < length; i++)); do
        local progress=$((i * 100 / (length - 1)))

        if [ $progress -lt 50 ]; then
            local factor=$((progress * 2))
            r=$((start_color[0] * (100 - factor) / 100 + mid_color[0] * factor / 100))
            g=$((start_color[1] * (100 - factor) / 100 + mid_color[1] * factor / 100))
            b=$((start_color[2] * (100 - factor) / 100 + mid_color[2] * factor / 100))
        else
            local factor=$(((progress - 50) * 2))
            r=$((mid_color[0] * (100 - factor) / 100 + end_color[0] * factor / 100))
            g=$((mid_color[1] * (100 - factor) / 100 + end_color[1] * factor / 100))
            b=$((mid_color[2] * (100 - factor) / 100 + end_color[2] * factor / 100))
        fi

        printf "\e[38;2;%d;%d;%dm%s" "$r" "$g" "$b" "${text:$i:1}"
    done
    echo -e "$reset"
}

# Function to send Telegram notification
send_telegram_notification() {
    local status="$1"
    local user="$2"
    local duration="$3"
    local error_msg="$4"
    
    if [ -f '/root/.vars' ]; then
        source '/root/.vars'
        
        if [ "$status" == "success" ]; then
            message="
<b>ğŸš€ Alrescha79 Panel VPN ğŸš€</b>
<b>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</b>
<b>âœ¨ SSH OVPN TRIAL ACCOUNT CREATED</b>
<b>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</b>
<b>ğŸ‘¤ Username:</b> <code>$user</code>
<b>ğŸ” Password:</b> <code>$user</code>
<b>ğŸŒ Host:</b> <code>$domain</code>
<b>ğŸŒ Slowdns Host:</b> <code>$ns_domain</code>
<b>ğŸ“ Location:</b> <code>$city</code>
<b>ğŸ”’ OpenSSH Port:</b> <code>443, 80, 22</code>
<b>ğŸ”Œ UdpSSH Port:</b> <code>1-65535</code>
<b>ğŸŒ DNS Port:</b> <code>443, 53, 22</code>
<b>ğŸ” Dropbear Port:</b> <code>443, 109</code>
<b>ğŸ” SSH WS Port:</b> <code>80, 8080</code>
<b>ğŸ” SSH SSL WS Port:</b> <code>443</code>
<b>ğŸ”’ SSL/TLS Port:</b> <code>443</code>
<b>ï¿½ OVPN SSL Port:</b> <code>443</code>
<b>ğŸ”’ OVPN TCP Port:</b> <code>1194</code>
<b>ğŸ”“ OVPN UDP Port:</b> <code>2200</code>
<b>ï¿½ğŸ“¡ BadVPN UDP:</b> <code>7100, 7300, 7300</code>
<b>ğŸ”‘ SlowDns Public Key:</b> <code>$public_key</code>
<b>â±ï¸ Duration:</b> <code>$duration minutes</code>
<b>â° Expiration:</b> <code>$expiration</code>
<b>âœ¨ Type:</b> <code>TRIAL ACCOUNT</code>
<b>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</b>
<b>ğŸ”— WSS Payload:</b> <code>GET wss://BUG.COM/ HTTP/1.1[crlf]Host: $domain[crlf]Upgrade: websocket[crlf][crlf]</code>
<b>ğŸ“± OpenVPN Link:</b> <code>https://$domain:81/allovpn.zip</code>
<b>ğŸ“ Save Account Link:</b> <code>https://$domain:81/ssh-$user.txt</code>
<b>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</b>
<b>ğŸŒŸ Alrescha79 Panel VPN ğŸŒŸ</b>
"
        else
            message="
<b>ğŸš€ Alrescha79 Panel VPN ğŸš€</b>
<b>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</b>
<b>âŒ SSH OVPN TRIAL CREATION FAILED</b>
<b>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</b>
<b>ğŸ‘¤ Username:</b> <code>$user</code>
<b>ğŸ” Password:</b> <code>$user</code>
<b>ğŸŒ Host:</b> <code>$domain</code>
<b>â— Error:</b> <code>$error_msg</code>
<b>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</b>
<b>ğŸŒŸ Alrescha79 Panel VPN ğŸŒŸ</b>
"
        fi
        
        curl -s -X POST "https://api.telegram.org/bot$bot_token/sendMessage" \
            -d "chat_id=$telegram_id" \
            -d "parse_mode=HTML" \
            -d "text=$message" > /dev/null 2>&1
    fi
}

# Variables
ip=$(wget -qO- ipv4.icanhazip.com)
server_date=$(curl -v --insecure --silent https://google.com/ 2>&1 | grep Date | sed -e 's/< Date: //')
date=$(date +"%Y-%m-%d" -d "$server_date")
ip_url="https://ip.yha.my.id/ip"
city=$(cat /etc/xray/city 2>/dev/null || echo "Unknown city")
public_key=$(cat /etc/slowdns/server.pub 2>/dev/null || echo "Public key not available")
ns_domain=$(cat /etc/xray/dns 2>/dev/null || echo "NS domain not set")
domain=$(cat /etc/xray/domain 2>/dev/null || hostname -f)

# Loading animation
echo ""
echo -ne "${yellow}Preparing Premium Account${reset}"
for i in {1..2}; do
    for j in â ‹ â ™ â ¹ â ¸ â ¼ â ´ â ¦ â § â ‡ â ; do
        echo -ne "\r${yellow}Preparing Premium Account $j${reset}"
        sleep 0.1
    done
done
echo -ne "\r${yellow}Premium Account Ready to be created!${reset}\n"
sleep 1
clear

# User data input
print_rainbow "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
print_rainbow "        Script by Alrescha79 Panel VPN"
print_rainbow "    Input SSH trial account data"
print_rainbow "            Enter User Data"
print_rainbow "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Generate random username
user=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 8 | head -n 1)

echo "   Username : $user"
until [[ $duration =~ ^[0-9]+$ ]]; do
    read -p "   Active period (minutes): " duration
    if [[ -z "$duration" ]]; then
        echo -e "${red}   Active period cannot be empty${reset}"
    fi
done

# Account creation process
expiration=$(date -d "+$duration minutes" +"%Y-%m-%d %H:%M:%S")

# Create SSH account
if ! useradd -e $(date -d "+$duration minutes" +"%Y-%m-%d") -s /bin/false -M $user; then
    echo -e "${red}Failed to create SSH user account${reset}"
    send_telegram_notification "error" "$user" "$duration" "Failed to create SSH user account"
    exit 1
fi

if ! echo "$user:$user" | chpasswd; then
    echo -e "${red}Failed to set SSH user password${reset}"
    send_telegram_notification "error" "$user" "$duration" "Failed to set SSH user password"
    exit 1
fi

# Run tmux session to delete account after duration expires
tmux new-session -d -s "trial_ssh_$user" "trial trialssh $user $duration"
send_telegram_notification "success" "$user" "$duration"

print_rainbow "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
print_rainbow "SSH OVPN Account      "
print_rainbow "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "Username         : $user"
echo -e "Password         : $user"
print_rainbow "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "IP               : $ip"
echo -e "Host             : $domain"
echo -e "Slowdns Host     : ${ns_domain}"
echo -e "Location         : $city"
echo -e "OpenSSH Port     : 443, 80, 22"
echo -e "UdpSSH Port      : 1-65535"
echo -e "DNS Port         : 443, 53, 22"
echo -e "Dropbear Port    : 443, 109"
echo -e "SSH WS Port      : 80, 8080"
echo -e "SSH SSL WS Port  : 443"
echo -e "SSL/TLS Port     : 443"
echo -e "OVPN SSL Port    : 443"
echo -e "OVPN TCP Port    : 1194"
echo -e "OVPN UDP Port    : 2200"
echo -e "BadVPN UDP       : 7100, 7300, 7300"
echo -e "SlowDns Public Key: ${public_key}"
print_rainbow "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "WSS Payload      : GET wss://BUG.COM/ HTTP/1.1[crlf]Host: $domain[crlf]Upgrade: websocket[crlf][crlf]"
print_rainbow "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "OpenVPN Link     : https://$domain:81/allovpn.zip"
print_rainbow "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "Save Account Link: https://$domain:81/ssh-$user.txt"
print_rainbow "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "Expiration       : $expiration"
echo -e ""
read -n 1 -s -r -p "Press [ Enter ] to back on menu"
menu
